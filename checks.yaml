# Homelab Smoke Test Checks
#
# Declarative configuration for cluster health validation.
# Checks are organized by layer (lower layers run first, fail fast).
#
# Exit Code Contract:
#   0 - PASS: Check succeeded
#   1 - FAIL: Check failed (gating by default)
#   2 - ERROR: Script/tool error (always blocks)
#   3 - SKIP: Not applicable for this environment
#   4 - WARN: Warning (non-blocking)
#
# Template Variables:
#   {{.Cluster}}   - Cluster name (e.g., "home")
#   {{.Namespace}} - Kubernetes namespace
#   {{.Context}}   - kubectl context
#
# Check Ordering Philosophy:
# Checks are ordered by dependency hierarchy (fail fast at lower layers):
#   Layer 1: Gateway Infrastructure (Envoy Gateway, LoadBalancer IPs)
#   Layer 2: Network Policies (traffic filtering)
#   Layer 3: Core Services (ArgoCD, DNS)
#   Layer 4: Observability (Grafana, Prometheus)
#   Layer 5: Application Services

checks:
  # ========================================================================
  # Layer 1: Gateway Infrastructure
  # ========================================================================

  - name: "Gateway Resources Programmed"
    description: "Verify all Gateway resources are programmed and have addresses"
    layer: 1
    script:
      path: "./scripts/infra/gateway-programmed.sh"
    expect:
      gating: true

  - name: "Envoy LoadBalancer IPs"
    description: "Verify Envoy LoadBalancer services have IPs assigned"
    layer: 1
    script:
      path: "./scripts/infra/loadbalancer-ips.sh"
    expect:
      gating: true

  - name: "No IP Conflicts"
    description: "Check for duplicate IP assignments across LoadBalancer services"
    layer: 1
    script:
      path: "./scripts/infra/ip-conflicts.sh"
    expect:
      gating: true

  - name: "Envoy Proxy Pods"
    description: "Verify Envoy proxy pods are running and ready"
    layer: 1
    script:
      path: "./scripts/infra/envoy-pods.sh"
    expect:
      gating: true

  - name: "Envoy DSR Configuration"
    description: "Verify DSR-compatible config: Local policy + nodeAffinity for BGP nodes"
    layer: 1
    script:
      path: "./scripts/infra/envoy-dsr-config.sh"
    expect:
      gating: true

  - name: "Cilium LB Pools"
    description: "Verify Cilium LoadBalancer IP pools are active and available"
    layer: 1
    script:
      path: "./scripts/infra/cilium-lb-pools.sh"
    expect:
      gating: true

  - name: "Registry Mirrors"
    description: "Verify Nexus registry proxies are accessible via ClusterIP"
    layer: 1
    script:
      path: "./scripts/infra/registry-mirrors.sh"
    expect:
      gating: false  # Non-gating - only affects image pull performance
    # Note: Must run from inside cluster to reach ClusterIP

  # ========================================================================
  # Layer 2: Network Policies
  # ========================================================================

  - name: "NetworkPolicy Container Ports"
    description: "Verify NetworkPolicy uses container ports (10080/10443) not service ports"
    layer: 2
    script:
      path: "./scripts/infra/networkpolicy-ports.sh"
    expect:
      gating: true

  - name: "NetworkPolicy Internal Traffic"
    description: "Verify NetworkPolicy allows internal cluster traffic"
    layer: 2
    script:
      path: "./scripts/infra/networkpolicy-internal.sh"
    expect:
      gating: true

  # ========================================================================
  # Layer 3: Core Services Connectivity
  # ========================================================================

  - name: "HTTP Connectivity to Gateway"
    description: "Test basic HTTP connectivity to Envoy LoadBalancer"
    layer: 3
    script:
      path: "./scripts/utils/httpcheck"
      args:
        - "http://10.10.0.1"
    retry: true
    timeout: 10s
    expect:
      gating: true
    validate:
      regex: '^HTTP [234][0-9]{2}'  # Any valid HTTP response

  - name: "ArgoCD Accessible"
    description: "Verify ArgoCD UI is reachable"
    layer: 3
    script:
      path: "./scripts/utils/httpcheck"
      args:
        - "https://argocd.erauner.dev"
    retry: true
    timeout: 10s
    expect:
      gating: false  # Non-gating for now
    validate:
      regex: '^HTTP [23][0-9]{2}'

  - name: "DNS Resolution"
    description: "Verify external DNS resolves critical hostnames to gateway IP"
    layer: 3
    script:
      path: "./scripts/infra/dns-resolution.sh"
    expect:
      gating: false  # Non-gating - DNS propagation can be slow

  # ========================================================================
  # Layer 4: Observability
  # ========================================================================

  - name: "Grafana Accessible"
    description: "Verify Grafana UI is reachable"
    layer: 4
    script:
      path: "./scripts/utils/httpcheck"
      args:
        - "https://grafana.erauner.dev"
    retry: true
    timeout: 10s
    expect:
      gating: false
    validate:
      regex: '^HTTP [23][0-9]{2}'

  # NOTE: Prometheus is internal-only (dns-scope: internal â†’ 10.10.0.2)
  # This check will fail from outside the cluster network.
  # TODO: Add internal vs external detection, or run from inside cluster.
  - name: "Prometheus Accessible"
    description: "Verify Prometheus is reachable (internal-only, may fail from outside)"
    layer: 4
    script:
      path: "./scripts/utils/httpcheck"
      args:
        - "https://prometheus.erauner.dev"
    retry: true
    timeout: 10s
    expect:
      gating: false
    validate:
      regex: '^HTTP [23][0-9]{2}'

  # ========================================================================
  # Layer 5: Application Services
  # ========================================================================

  - name: "Jenkins Accessible"
    description: "Verify Jenkins CI is reachable"
    layer: 5
    script:
      path: "./scripts/utils/httpcheck"
      args:
        - "https://jenkins.erauner.dev"
    retry: true
    timeout: 10s
    expect:
      gating: false
    validate:
      regex: '^HTTP [234][0-9]{2}'

  # ========================================================================
  # Kyverno Policies (no layer - runs after infrastructure)
  # ========================================================================

  - name: "Kyverno Gateway Policies"
    description: "Check for Kyverno policies that might block Gateway resources"
    layer: 6
    script:
      path: "./scripts/infra/kyverno-gateway.sh"
    expect:
      gating: false  # Informational only

  # ========================================================================
  # Layer 7: Storage Infrastructure
  # ========================================================================

  - name: "Democratic CSI (TrueNAS NFS)"
    description: "Verify democratic-csi TrueNAS NFS provisioner is operational"
    layer: 7
    script:
      path: "./scripts/infra/democratic-csi.sh"
    timeout: 120s
    expect:
      gating: false  # Non-gating - storage is optional for some workloads

  - name: "TrueNAS LACP Bond"
    description: "Verify TrueNAS LACP bond with parallel NFS throughput test"
    layer: 7
    script:
      path: "./scripts/infra/truenas-lacp.sh"
    timeout: 180s
    expect:
      gating: false  # Non-gating - bond health check
